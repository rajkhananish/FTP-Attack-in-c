#include <stdio.h>      /* for printf() and fprintf() */#include <sys/socket.h> /* for socket(), connect(), send(), and recv() */#include <arpa/inet.h>  /* for sockaddr_in and inet_addr() */#include <stdlib.h>    /* for atoi() and exit() */#include <string.h>    /* for memset() */#include <unistd.h>    /* for close() */#include "Utils.h"#include "HandleTCPServer.h"void Streams (int sock, int *success) {     int dataSock = 0;     /* Enter passive mode so client established data stream connection */    strcpy(clntBuf, "PASV\n");    sendMessage(sock,clntBuf,strlen(clntBuf));    /* Server responds with Passive Details */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 227)	if(returnCode(srvBuf) == 500 || returnCode(srvBuf) == 501 || returnCode(srvBuf) == 502)	   {	     errorMessage("Command Not Recognized");           }         else if (returnCode(srvBuf) == 530)           {	     errorMessage("User Not Logged In");           }         else if (returnCode(srvBuf) == 421)           {	     errorMessage("Service Unavailable");           }        else           {	     errorMessage("PASV failed!");           }    processPASV(srvBuf, clntBuf, &port);    printf(" == PASV FTP Data Connection: Server [%s] Port [%d] ==\n", clntBuf, port);     /* create passive data stream */    dataSock = createAndConnectSocket(clntBuf, port);        /* send list command */    strcpy(clntBuf,"LIST\n");    sendMessage(sock,clntBuf,strlen(clntBuf));    /* receive response through command stream */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 150)       {	 if(returnCode(srvBuf) == 125)	    {               errorMessage("Data connection Already open, transfer starting");            }         else if(returnCode(srvBuf) == 421)	    {               errorMessage("Service Unavailable");            }         else if(returnCode(srvBuf) == 425)	    {               errorMessage("Can't open Data connection");            }         else if(returnCode(srvBuf) == 426)	    {               errorMessage("Connection Close, transfer aborted");            }         else if(returnCode(srvBuf) == 450)	    {               errorMessage("Requesting Action Aborted");            }         else if(returnCode(srvBuf) == 451)	    {               errorMessage("Action Aborted");            }         else	    {               errorMessage("LIST Start Error!");            }       }   /* Receive Data */    msgSize = receiveData(dataSock, srvBuf, sizeof(srvBuf));   /* close datastream after usage */    close(dataSock);   /* line Sorting Function to sort the received message*/    lineSort(srvBuf);   /* Command stream response */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 226)       {         if(returnCode(srvBuf) == 125)	    {               errorMessage("Data connection Already open, transfer starting");            }         else if(returnCode(srvBuf) == 421)	    {               errorMessage("Service Unavailable");            }         else if(returnCode(srvBuf) == 425)	    {               errorMessage("Can't open Data connection");            }         else if(returnCode(srvBuf) == 426)	    {               errorMessage("Connection Close, transfer aborted");            }         else if(returnCode(srvBuf) == 450)	    {               errorMessage("Requesting Action Aborted");            }         else if(returnCode(srvBuf) == 451)	    {               errorMessage("Action Aborted");            }         else if(returnCode(srvBuf) == 452)	    {               errorMessage("Insufficient storage apace in system");            }         else if(returnCode(srvBuf) == 500 || returnCode(srvBuf) == 501 || returnCode(srvBuf) == 502 || returnCode(srvBuf) == 503)	    {               errorMessage("Command Not Recognised");            }          else	    {               errorMessage("LIST End Error");            }       }      /* complete transaction */    strcpy(clntBuf,"QUIT\n");    sendMessage(sock,clntBuf,strlen(clntBuf));      /* QUIT Response */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 221)       {          if(returnCode(srvBuf) == 500)	    {               errorMessage("Command Not Recognised");            }           else	    {               errorMessage("Quit Error!");            }       } }void HandleTCPServer(int sock, char *sentUser, char *sentPass, int *success, int *sucindicator){    /* Receive Header (assuming single line header)*/    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 220)	{	   if(returnCode(srvBuf) == 120)	    {               errorMessage("Service Not ready");            }          else if(returnCode(srvBuf) == 500 || returnCode(srvBuf) == 501 || returnCode(srvBuf) == 502 || returnCode(srvBuf) == 503)	    {               errorMessage("Command Not Recognised");            }           else	    {              errorMessage("FTP Header Error!");            }	}    /* send username */    //strcpy(clntBuf,"USER student\n");    //strcpy(clntBuf,"USER testftp\n");      sprintf(clntBuf,"USER %s\n",sentUser);    sendMessage(sock,clntBuf,strlen(clntBuf));    /* response to USER command */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 331)	{	    errorMessage("Password Not Requested!");           if(returnCode(srvBuf) == 230)	    {               Streams(sock, success);               *sucindicator = 1;            }	  else if(returnCode(srvBuf) == 421)	    {               errorMessage("Service Unavailable");            }	  else if(returnCode(srvBuf) == 500 || returnCode(srvBuf) == 501)	    {               errorMessage("Command Not Recognised");            }	  else if(returnCode(srvBuf) == 503)	    {               errorMessage("Username Invalid");            }	}	 else           {    /* send password */    //strcpy(clntBuf,"PASS northumbria\n");     // strcpy(clntBuf,"PASS mm\n");           sprintf(clntBuf,"PASS %s\n",sentPass);    sendMessage(sock,clntBuf,strlen(clntBuf));    /* receive password response */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 230)	{	   if(returnCode(srvBuf) == 500)	    {                if(strstr(srvBuf, "cannot change directory:") != NULL)		    {			printf("***************************************************\n");			printf("Successfully Logged In Using: %s & %s\n", sentUser, sentPass);			printf("Credentials: %s, %s has no home Directory.\n", sentUser, sentPass);			*sucindicator = 1;			sleep(5);		    }		else	    	{                    errorMessage("Command Not Recognised");            	}            }	     else		{		  if(returnCode(srvBuf) == 421)	    	   {                     errorMessage("Service Unavailable");                   }		 else if(returnCode(srvBuf) == 501 || returnCode(srvBuf) == 503)	          {                     errorMessage("Command Not Recognised");                  }       /* complete transaction */    strcpy(clntBuf,"QUIT\n");    sendMessage(sock,clntBuf,strlen(clntBuf));      /* QUIT Response */    receiveMessage(sock,srvBuf,sizeof(srvBuf));    printf("[%d] %s",returnCode(srvBuf),srvBuf);    if (returnCode(srvBuf) != 221)         {          if(returnCode(srvBuf) == 500)	    {               errorMessage("Command Not Recognised");            }           else	    {               errorMessage("Quit Error!");            }          }	}       }        else	   {		printf("***************************************************\n");	        printf("Successfully Logged In Using: %s and %s\n", sentUser, sentPass);		printf("***************************************************\n");	      Streams(sock, success);	      *sucindicator = 1;	   }  }}